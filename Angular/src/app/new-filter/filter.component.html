
<div class="bg-white w-full flex" [class.flex-col]="viewType == 1 || !isL" [class.flex-row]="viewType == 2 && isL" [class.fit-to-screen]="viewType == 2 && isL"> 
    <!-- Controller Box -->
    <div style="background-color: rgb(229 231 235)" class="flex flex-col" [class.w-1-3]="viewType == 2 && isL" [class.overflow-y-scroll]="viewType == 2 && isL" [class.fit-to-screen]="viewType == 2 && isL">
        <!-- Desktop Header -->
        <div *ngIf="isL && viewType == 1" class="flex flex-row h-[3.2rem] sticky top-[49px] w-full" style="z-index: 3; box-shadow: 0px 4px 8px -4px rgb(138, 138, 138);">
            <!-- Data Selector -->
            <div class="w-2-7 flex flex-row items-center bg-[#569CD7] px-4">
                <svg class="cursor-pointer" (click)="scrollToTop()" xmlns="http://www.w3.org/2000/svg" fill="white" height="30px" viewBox="0 0 512 512"><path d="M409.43 389.87C362 410 305.4 421.05 256 421.05s-105.87-11.3-153.44-31.18S48 353.16 48 353.16v38.2c0 31.15 18 43.64 67.32 64.35C153.13 471.59 203.18 480 256 480s102.87-8.41 140.68-24.29C446 435 464 422.51 464 391.36v-38.2s-7.14 16.59-54.57 36.71zM63.69 173.22c11.23 9.84 27.82 19.49 48 27.92 42.48 17.76 96.45 28.37 144.36 28.37s101.88-10.61 144.36-28.37c20.13-8.43 36.72-18.08 47.95-27.92 6.06-5.31 10.85-10.12 13.47-12.85a8 8 0 002.22-5.54v-26.16c-.84-28.79-24.71-54.41-67.21-72.14C358.83 40.71 308.84 32 256 32s-102.83 8.71-140.74 24.53C72.85 74.22 49 99.78 48.05 128.5v26.33a8 8 0 002.21 5.54c2.58 2.73 7.36 7.54 13.43 12.85z"/><path d="M409.43 221.91C365 241 305.4 253.09 256 253.09s-108.87-12.27-153.43-31.18S48 185.2 48 185.2v47.36c.08 7.52 5.5 16.2 15.69 25.13 11.24 9.84 27.82 19.5 48 27.92C154.12 303.38 208.09 314 256 314s101.88-10.6 144.36-28.37c20.13-8.42 36.72-18.08 47.95-27.92 10.25-9 15.68-17.71 15.69-25.27V185.2s-10.13 17.62-54.57 36.71z"/><path d="M409.43 306.38C362 326 305.4 337.56 256 337.56s-109.87-12.8-153.43-31.18S48 269.67 48 269.67v46.25c0 7.55 5.44 16.28 15.69 25.26 11.23 9.84 27.81 19.5 48 27.92 42.48 17.77 96.44 28.37 144.36 28.37s101.88-10.6 144.36-28.37c20.13-8.43 36.72-18.08 47.95-27.92 10.19-8.93 15.61-17.61 15.69-25.13v-46.38s-7.18 17.09-54.62 36.71z"/></svg>
                <span class="pl-2 header-type text-white">Data Selector</span>
            </div>
            <!-- Query Builder -->
            <div class="w-3-7 flex flex-row items-center bg-white px-4 " style="border-right: 1px#e5e7eb solid">
                <svg class="cursor-pointer" (click)="scrollToTop()" fill="#535353" xmlns="http://www.w3.org/2000/svg" height="30px" viewBox="0 0 512 512"><path d="M294.28 256.9l-54.42-54.41a12 12 0 00-17 0L12.45 401a12 12 0 00-.27 17.2l66.05 66.28a12 12 0 0017.22-.23l198.81-210.36a12 12 0 00.02-16.99zM499.33 199.33l-43.89-43.58a21.46 21.46 0 00-15.28-6.26 21.89 21.89 0 00-12.79 4.14c0-.43.06-.85.09-1.22.45-6.5 1.15-16.32-5.2-25.22a258 258 0 00-24.8-28.74.6.6 0 00-.08-.08c-13.32-13.12-42.31-37.83-86.72-55.94A139.55 139.55 0 00257.56 32C226 32 202 46.24 192.81 54.68A53.4 53.4 0 00176 86.17L192 96s8.06-2 13.86-3.39a62.73 62.73 0 0118.45-1.15c13.19 1.09 28.79 7.64 35.69 13.09 11.7 9.41 17.33 22.09 18.26 41.09.2 4.23-9.52 21.35-24.16 39.84a8 8 0 00.61 10.62l45.37 45.37a8 8 0 0011 .25c12.07-11 30.49-28 34.67-30.59 7.69-4.73 13.19-5.64 14.7-5.8a19.18 19.18 0 0111.29 2.38 1.24 1.24 0 01-.31.95l-1.82 1.73-.3.28a21.52 21.52 0 00.05 30.54l43.95 43.68a8 8 0 0011.28 0l74.68-74.2a8 8 0 00.06-11.36z"/></svg>
                <span  class="pl-2 header-type text-[#535353]">Query Builder</span>
            </div>
            <!-- Run Control -->
            <div class="w-2-7 flex flex-row items-center bg-white px-4">
                <svg class="cursor-pointer" (click)="scrollToTop()" xmlns="http://www.w3.org/2000/svg" height="30px" fill="#569CD7" viewBox="0 0 512 512"><path d="M96 448l320-192L96 64v384z"/></svg>
                <span class="pl-2 header-type text-[#569CD7]">Run Control</span>
            </div>
        </div>
        <div [class.flex-row]="isL && viewType == 1" [class.flex-col]="!isL || viewType == 2" class="flex">
        <!-- Meta information -->
        <div style="box-shadow: 4px 0 8px -2px rgb(138, 138, 138);" [class.w-2-7]="isL && viewType == 1" [class.w-full]="!isL || viewType == 2" class="flex flex-col bg-white">
            <!-- Header -->
            <div *ngIf="!isL || viewType == 2"  [class.top-0]="viewType == 2 && isL" [class.top-49]="!isL" class="flex flex-row items-center bg-[#569CD7] px-4 h-14 sticky" style="box-shadow: 0px 4px 8px -4px rgb(138, 138, 138); z-index: 4;">
                <svg class="cursor-pointer" (click)="scrollToTop()" xmlns="http://www.w3.org/2000/svg" fill="white" height="30px" viewBox="0 0 512 512"><path d="M409.43 389.87C362 410 305.4 421.05 256 421.05s-105.87-11.3-153.44-31.18S48 353.16 48 353.16v38.2c0 31.15 18 43.64 67.32 64.35C153.13 471.59 203.18 480 256 480s102.87-8.41 140.68-24.29C446 435 464 422.51 464 391.36v-38.2s-7.14 16.59-54.57 36.71zM63.69 173.22c11.23 9.84 27.82 19.49 48 27.92 42.48 17.76 96.45 28.37 144.36 28.37s101.88-10.61 144.36-28.37c20.13-8.43 36.72-18.08 47.95-27.92 6.06-5.31 10.85-10.12 13.47-12.85a8 8 0 002.22-5.54v-26.16c-.84-28.79-24.71-54.41-67.21-72.14C358.83 40.71 308.84 32 256 32s-102.83 8.71-140.74 24.53C72.85 74.22 49 99.78 48.05 128.5v26.33a8 8 0 002.21 5.54c2.58 2.73 7.36 7.54 13.43 12.85z"/><path d="M409.43 221.91C365 241 305.4 253.09 256 253.09s-108.87-12.27-153.43-31.18S48 185.2 48 185.2v47.36c.08 7.52 5.5 16.2 15.69 25.13 11.24 9.84 27.82 19.5 48 27.92C154.12 303.38 208.09 314 256 314s101.88-10.6 144.36-28.37c20.13-8.42 36.72-18.08 47.95-27.92 10.25-9 15.68-17.71 15.69-25.27V185.2s-10.13 17.62-54.57 36.71z"/><path d="M409.43 306.38C362 326 305.4 337.56 256 337.56s-109.87-12.8-153.43-31.18S48 269.67 48 269.67v46.25c0 7.55 5.44 16.28 15.69 25.26 11.23 9.84 27.81 19.5 48 27.92 42.48 17.77 96.44 28.37 144.36 28.37s101.88-10.6 144.36-28.37c20.13-8.43 36.72-18.08 47.95-27.92 10.19-8.93 15.61-17.61 15.69-25.13v-46.38s-7.18 17.09-54.62 36.71z"/></svg>
                <span class="pl-2 header-type text-white">Data Selector</span>
            </div>
            <!-- Table vs Map controller -->
            <mat-tab-group [selectedIndex]="viewType - 1" (selectedTabChange)="changeViewType($event)" mat-align-tabs="center" style="z-index: 2; margin-top: 0px; margin-bottom: 0px; background-color: white; box-shadow: 0px 4px 8px -4px rgb(138, 138, 138);">
                <mat-tab>
                    <ng-template mat-tab-label>
                        <mat-icon style="vertical-align: middle;"> table_chart</mat-icon>
                        <span class="header-2-type">&nbsp;&nbsp;Table View</span>
                    </ng-template>
                </mat-tab>
                <mat-tab>
                    <ng-template mat-tab-label>
                        <mat-icon style="vertical-align: middle;"> map</mat-icon>
                        <span class="header-2-type">&nbsp;&nbsp;Map View</span>
                    </ng-template>
                </mat-tab>
            </mat-tab-group>
            <!-- Field Selections -->
            <div *ngIf="viewType == 1" class="flex flex-row justify-between items-center bg-white pl-4 pr-2 py-3 border-b" style="z-index:1;">
                <span class="header-3-type text-[#535353]">Database <a matTooltip="Read the guide" style="display: inline-block; padding-left: 3px" target="_blank" href="/guide/query#multi-database"><img width="16px" height="16px" src="/assets/info-gray.png" alt=""></a></span>
                <mat-form-field appearance="fill" style="margin-bottom: -21px; font-size: 0.9rem">
                    <mat-label>Select Database</mat-label>
                    <mat-select [(ngModel)]="queryState.tableView.selectedDatabase" (ngModelChange)="onDatabaseChange(1)">
                        <mat-option *ngFor="let db of databases; index as i" [value]="i">{{ db.name }}</mat-option>
                    </mat-select>
                </mat-form-field>              
            </div>
            <div *ngIf="viewType == 1" class="flex flex-row justify-between items-center bg-white pl-4 pr-2 py-3 border-b">
                <span class="header-3-type text-[#535353]">Query Type <a matTooltip="Read the guide" style="display: inline-block; padding-left: 3px" target="_blank" href="/guide/query#query-type"><img width="16px" height="16px" src="/assets/info-gray.png" alt=""></a></span>
                <mat-form-field appearance="fill" style="margin-bottom: -21px; font-size: 0.9rem">
                    <mat-label>Select Query Type</mat-label>
                    <mat-select [(ngModel)]="queryState.tableView.queryType" (ngModelChange)="onQueryTypeChange(1)">
                        <mat-option value="Items">Items</mat-option>
                        <mat-option value="Observations">Observations</mat-option>
                    </mat-select>
                </mat-form-field>              
            </div>
            <div *ngIf="viewType == 1" class="flex flex-row justify-between items-center bg-white pl-4 pr-2 py-3 border-b">
                <span class="header-3-type text-[#535353]">Feature</span>
                <mat-form-field appearance="fill" style="margin-bottom: -21px; font-size: 0.9rem">
                    <mat-label>Select Feature</mat-label>
                    <mat-select [(ngModel)]="queryState.tableView.selectedFeature" (ngModelChange)="onFeatureSelectChange(1)">
                        <mat-option *ngFor="let obj of queryState.tableView.featuresOrItems; index as i" [value]="i">{{ obj.frontendName }}</mat-option>
                    </mat-select>
                </mat-form-field>              
            </div>
            <div *ngIf="viewType == 1" class="flex flex-row justify-between items-center bg-white pl-4 pr-2 py-3 border-b" matTooltip="Only geospatial fields allowed" [matTooltipDisabled]="viewType == 1">
                <span class="header-3-type text-[#535353]">Fields</span>
                <mat-form-field appearance="fill" style="margin-bottom: -21px; font-size: 0.9rem">
                    <mat-label>Select Fields</mat-label>
                    <mat-select [(ngModel)]="queryState.tableView.selectedFields" (ngModelChange)="onFieldSelection(1)" multiple>
                    <mat-option *ngFor="let id of queryState.tableView.currentReturnableIDs; index as i" [value]="i">{{ queryState.tableView.currentColumnObjects[i].frontendName }}</mat-option>
                    </mat-select>
                </mat-form-field>              
            </div>
            <div *ngIf="viewType == 2" class="flex flex-row justify-between items-center bg-white pl-4 pr-2 py-3 border-b" style="z-index:1;">
                <span class="header-3-type text-[#535353]">Database <a matTooltip="Read the guide" style="display: inline-block; padding-left: 3px" target="_blank" href="/guide/query#multi-database"><img width="16px" height="16px" src="/assets/info-gray.png" alt=""></a></span>
                <mat-form-field appearance="fill" style="margin-bottom: -21px; font-size: 0.9rem">
                    <mat-label>Select Database</mat-label>
                    <mat-select [(ngModel)]="queryState.mapView.selectedDatabase" (ngModelChange)="onDatabaseChange(2)">
                        <mat-option *ngFor="let db of databases; index as i" [value]="i">{{ db.name }}</mat-option>
                    </mat-select>
                </mat-form-field>              
            </div>
            <div *ngIf="viewType == 2" class="flex flex-row justify-between items-center bg-white pl-4 pr-2 py-3 border-b">
                <span class="header-3-type text-[#535353]">Query Type <a matTooltip="Read the guide" style="display: inline-block; padding-left: 3px" target="_blank" href="/guide/query#query-type"><img width="16px" height="16px" src="/assets/info-gray.png" alt=""></a></span>
                <mat-form-field appearance="fill" style="margin-bottom: -21px; font-size: 0.9rem">
                    <mat-label>Select Query Type</mat-label>
                    <mat-select [(ngModel)]="queryState.mapView.queryType" (ngModelChange)="onQueryTypeChange(2)">
                        <mat-option value="Items">Items</mat-option>
                        <mat-option value="Observations">Observations</mat-option>
                    </mat-select>
                </mat-form-field>              
            </div>
            <div *ngIf="viewType == 2" class="flex flex-row justify-between items-center bg-white pl-4 pr-2 py-3 border-b">
                <span class="header-3-type text-[#535353]">Feature</span>
                <mat-form-field appearance="fill" style="margin-bottom: -21px; font-size: 0.9rem">
                    <mat-label>Select Feature</mat-label>
                    <mat-select [(ngModel)]="queryState.mapView.selectedFeature" (ngModelChange)="onFeatureSelectChange(2)">
                        <mat-option *ngFor="let obj of queryState.mapView.featuresOrItems; index as i" [value]="i">{{ obj.frontendName }}</mat-option>
                    </mat-select>
                </mat-form-field>              
            </div>
            <div *ngIf="viewType == 2" class="flex flex-row justify-between items-center bg-white pl-4 pr-2 py-3 border-b" matTooltip="Only geospatial fields allowed" [matTooltipDisabled]="viewType == 1">
                <span class="header-3-type text-[#535353]">Fields</span>
                <mat-form-field appearance="fill" style="margin-bottom: -21px; font-size: 0.9rem">
                    <mat-label>Add Fields</mat-label>
                    <mat-select (selectionChange)="onFieldSelection(2, $event)">
                    <mat-option *ngFor="let obj of queryState.mapView.currentGeospatialFieldObjects" [value]="obj.arrayIndex" >{{ obj.columnObject.frontendName }}</mat-option>
                    </mat-select>
                </mat-form-field>              
            </div>  
        </div>

        <!-- Query Builder -->
        <div [class.w-3-7]="isL && viewType == 1" [class.w-full]="!isL || viewType == 2">
            <!-- Header -->
            <div *ngIf="!isL || viewType == 2" [class.top-0]="viewType == 2 && isL" [class.top-49]="!isL" class="flex flex-row items-center bg-white px-4 h-14 sticky" style="box-shadow: 0px 4px 8px -4px rgb(138, 138, 138); z-index: 3;">
                <svg class="cursor-pointer" (click)="scrollToTop()" fill="#535353" xmlns="http://www.w3.org/2000/svg" height="30px" viewBox="0 0 512 512"><path d="M294.28 256.9l-54.42-54.41a12 12 0 00-17 0L12.45 401a12 12 0 00-.27 17.2l66.05 66.28a12 12 0 0017.22-.23l198.81-210.36a12 12 0 00.02-16.99zM499.33 199.33l-43.89-43.58a21.46 21.46 0 00-15.28-6.26 21.89 21.89 0 00-12.79 4.14c0-.43.06-.85.09-1.22.45-6.5 1.15-16.32-5.2-25.22a258 258 0 00-24.8-28.74.6.6 0 00-.08-.08c-13.32-13.12-42.31-37.83-86.72-55.94A139.55 139.55 0 00257.56 32C226 32 202 46.24 192.81 54.68A53.4 53.4 0 00176 86.17L192 96s8.06-2 13.86-3.39a62.73 62.73 0 0118.45-1.15c13.19 1.09 28.79 7.64 35.69 13.09 11.7 9.41 17.33 22.09 18.26 41.09.2 4.23-9.52 21.35-24.16 39.84a8 8 0 00.61 10.62l45.37 45.37a8 8 0 0011 .25c12.07-11 30.49-28 34.67-30.59 7.69-4.73 13.19-5.64 14.7-5.8a19.18 19.18 0 0111.29 2.38 1.24 1.24 0 01-.31.95l-1.82 1.73-.3.28a21.52 21.52 0 00.05 30.54l43.95 43.68a8 8 0 0011.28 0l74.68-74.2a8 8 0 00.06-11.36z"/></svg>
                <span  class="pl-2 header-type text-[#535353]">Query Builder</span>
            </div>
            <!-- Query Builder + Sort / Layer Selection -->
            <div class="flex flex-col m-3">
                <!-- Map View -->
                <mat-expansion-panel *ngIf="viewType == 2" [(expanded)]="expandedPanelLookup['map-builder-global']">
                    <mat-expansion-panel-header>
                        <mat-panel-title>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="#535353" height="22px" viewBox="0 0 512 512"><path d="M267 474l-.8-.13a.85.85 0 00.8.13zM448.9 187.78a5.51 5.51 0 00-10.67-.63A5.52 5.52 0 01433 191h-15.47a5.48 5.48 0 01-2.84-.79l-22.38-13.42a5.48 5.48 0 00-2.84-.79h-35.8a5.48 5.48 0 00-3.06.93l-44.15 29.43A5.52 5.52 0 00304 211v41.74a5.51 5.51 0 002.92 4.87l57.89 30.9a5.55 5.55 0 012.92 4.8l.27 23.49a5.53 5.53 0 002.85 4.75l23.26 12.87a5.54 5.54 0 012.85 4.83v48.6a5.52 5.52 0 009.17 4.14c9.38-8.26 22.83-20.32 24.62-23.08q4.44-6.87 8.33-14.07a207.39 207.39 0 0013.6-31c12.68-36.71 2.66-102.7-3.78-136.06zM286.4 302.8l-61.33-46a4 4 0 00-2.4-.8h-29.1a3.78 3.78 0 01-2.68-1.11l-13.72-13.72a4 4 0 00-2.83-1.17h-53.19a3.79 3.79 0 01-2.68-6.47l8.42-8.42a3.78 3.78 0 012.68-1.11h32.37a8 8 0 007.7-5.83l6.89-24.5a4 4 0 012-2.47L206 177.06a3.79 3.79 0 002.05-3.37v-12.5a3.82 3.82 0 01.68-2.17l14.6-21.02a3.75 3.75 0 011.78-1.38l20.43-7.67a3.79 3.79 0 002.46-3.55V114a3.8 3.8 0 00-1.69-3.16l-20.48-13.62A3.83 3.83 0 00222 97l-27.88 13.94a3.78 3.78 0 01-4-.41l-13.22-10.45a3.8 3.8 0 01.1-6l10.74-7.91a3.78 3.78 0 00-.09-6.16l-16.73-11.67a3.78 3.78 0 00-4-.22c-6.05 3.31-23.8 13.11-30.1 17.52a209.48 209.48 0 00-68.16 80c-1.82 3.76-4.07 7.59-4.29 11.72s-3.46 13.35-4.81 17.08a3.78 3.78 0 00.24 3.1l35.69 65.58a3.74 3.74 0 001.38 1.44l37.55 22.54a3.78 3.78 0 011.81 2.73l7.52 54.54a3.82 3.82 0 001.61 2.61l29.3 20.14a4 4 0 011.65 2.48l15.54 73.8a3.6 3.6 0 00.49 1.22c1.46 2.36 7.28 11 14.3 12.28-.65.18-1.23.59-1.88.78a47.63 47.63 0 015 1.16c2 .54 4 1 6 1.43 3.13.62 3.44 1.1 4.94-1.68 2-3.72 4.29-5 6-5.46a3.85 3.85 0 002.89-2.9l10.07-46.68a4 4 0 011.6-2.42l45-31.9a4 4 0 001.69-3.27V306a4 4 0 00-1.55-3.2z"/><path d="M262 48s-3.65.21-4.39.23q-8.13.24-16.22 1.12A207.45 207.45 0 00184.21 64c2.43 1.68-1.75 3.22-1.75 3.22L189 80h35l24 12 21-12zM354.23 120.06l16.11-14a4 4 0 00-.94-6.65l-18.81-8.73a4 4 0 00-5.3 1.9l-7.75 16.21a4 4 0 001.49 5.11l10.46 6.54a4 4 0 004.74-.38zM429.64 140.67l-5.83-9c-.09-.14-.17-.28-.25-.43-1.05-2.15-9.74-19.7-17-26.51-5.45-5.15-7-3.67-7.43-2.53a3.77 3.77 0 01-1.19 1.6l-28.84 23.31a4 4 0 01-2.51.89h-14.93a4 4 0 00-2.83 1.17l-12 12a4 4 0 000 5.66l12 12a4 4 0 002.83 1.17h75.17a4 4 0 004-4.17l-.55-13.15a4 4 0 00-.64-2.01z"/><path d="M256 72a184 184 0 11-130.1 53.9A182.77 182.77 0 01256 72m0-40C132.3 32 32 132.3 32 256s100.3 224 224 224 224-100.3 224-224S379.7 32 256 32z"/></svg>
                            <span class="header-3-type text-[#535353]">
                                &nbsp;&nbsp;Global Filters
                            </span>
                        </mat-panel-title>
                        <mat-panel-description>
                        Applied to every layer
                        </mat-panel-description>
                    </mat-expansion-panel-header>                 
                    <div id="map-builder-global"></div>
                </mat-expansion-panel>
                <mat-expansion-panel *ngIf="viewType == 2"  class="mt-3" [(expanded)]="expandedPanelLookup['map-builder-layers']">
                    <mat-expansion-panel-header>
                        <mat-panel-title >
                            <svg xmlns="http://www.w3.org/2000/svg" fill="#535353" height="22px" viewBox="0 0 512 512"><path d="M480 150L256 48 32 150l224 104 224-104zM255.71 392.95l-144.81-66.2L32 362l224 102 224-102-78.69-35.3-145.6 66.25z"/><path d="M480 256l-75.53-33.53L256.1 290.6l-148.77-68.17L32 256l224 102 224-102z"/></svg>
                            <span class="header-3-type text-[#535353]">
                                &nbsp;&nbsp;Layer Inspector
                            </span>
                        </mat-panel-title>
                        <mat-panel-description>
                            Editing {{queryState.mapView.layers.length}} {{queryState.mapView.layers.length == 1 ? 'layer' : 'layers'}}
                        </mat-panel-description>
                    </mat-expansion-panel-header>                 
                    <!-- Layer Menu -->            
                    <div *ngIf="queryState.mapView.layers.length > 0" cdkDropList (cdkDropListDropped)="layerDropped($event)" class="space-y-2">
                        <mat-expansion-panel [(expanded)]="layer.isExpanded" *ngFor="let layer of queryState.mapView.layers" cdkDrag style="border: #535353 solid 1px">                            
                          <mat-expansion-panel-header class="relative">
                                <div *ngIf="layer.isRendering || layer.isQuerying" style="position: absolute !important; top: 0 !important; left: 0 !important; height: 3px !important; width: 100% !important; overflow-x: hidden !important;">
                                    <div class="line"></div>
                                    <div class="subline inc"></div>
                                    <div class="subline dec"></div>
                                </div>
                                <mat-panel-title cdkDragHandle class="cursor-move">
                                    <svg *ngIf="layer.type == 'geoPoint'" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" fill="#535353" matTooltip="Point" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="22px" height="22px" viewBox="0 0 32.25 32.25" style="enable-background:new 0 0 32.25 32.25;" xml:space="preserve">
                                        <g>
                                            <path d="M16.125,0C7.233,0,0,7.232,0,16.125C0,25.018,7.233,32.25,16.125,32.25c8.893,0,16.125-7.232,16.125-16.125   C32.25,7.232,25.016,0,16.125,0z M16.125,28.25C9.439,28.25,4,22.811,4,16.125C4,9.439,9.439,4,16.125,4   C22.811,4,28.25,9.439,28.25,16.125C28.25,22.811,22.811,28.25,16.125,28.25z M21.25,16.125c0,2.83-2.295,5.125-5.125,5.125   S11,18.955,11,16.125S13.295,11,16.125,11S21.25,13.295,21.25,16.125z"/>
                                        </g>
                                    </svg>    
                                    
                                    <svg *ngIf="layer.type == 'geoRegion'" matTooltip="Region" xmlns="http://www.w3.org/2000/svg" height="22px" width="22px" fill="#535353" viewBox="0 0 60 60" sodipodi:version="0.32" _SVGFile__filename="oldscale/actions/circle.svg" version="1.0" y="0" x="0" sodipodi:docname="kig_polygon.svgz" sodipodi:docbase="/home/danny/work/icons/mono/scalable/kig">
                    
                                        <path id="path1345" sodipodi:nodetypes="ccccc" style="stroke-linejoin:round;color:#535353;stroke:#ffffff;stroke-linecap:round;stroke-width:10;fill:none" d="m14.377 23.115l28.246-13 8 30.246-41.246 10 5-27.246z"/>
                                        <path id="path1321" style="stroke-linejoin:round;color:#535353;display:block;stroke:#ffffff;stroke-linecap:round;stroke-width:8.125;fill:none" d="m20.773 23.483c0 3.276-2.658 5.935-5.934 5.935s-5.9349-2.659-5.9349-5.935 2.6589-5.934 5.9349-5.934 5.934 2.658 5.934 5.934z"/>
                                        <path id="path2085" style="stroke-linejoin:round;color:#535353;display:block;stroke:#ffffff;stroke-linecap:round;stroke-width:8.125;fill:none" d="m55.313 39.992c0 3.276-2.659 5.935-5.935 5.935s-5.935-2.659-5.935-5.935c0-3.275 2.659-5.934 5.935-5.934s5.935 2.659 5.935 5.934z"/>
                                        <path id="path1318" style="stroke-linejoin:round;color:#535353;display:block;stroke:#ffffff;stroke-linecap:round;stroke-width:8.125;fill:none" d="m16.557 49.116c0 3.276-2.659 5.935-5.935 5.935-3.2758 0-5.9345-2.659-5.9345-5.935s2.6587-5.935 5.9345-5.935c3.276 0 5.935 2.659 5.935 5.935z"/>
                                        <path id="path1317" style="stroke-linejoin:round;color:#535353;display:block;stroke:#ffffff;stroke-linecap:round;stroke-width:8.125;fill:none" d="m48.361 10.884c0 3.276-2.658 5.935-5.934 5.935s-5.935-2.659-5.935-5.935c0-3.2759 2.659-5.9346 5.935-5.9346s5.934 2.6587 5.934 5.9346z"/>
                                        <path id="rect2089" sodipodi:nodetypes="ccccc" style="stroke-linejoin:round;color:#535353;stroke:#535353;stroke-linecap:round;stroke-width:5;fill:#ffffff" d="m14.377 23.115l28.246-13 8 30.246-41.246 10 5-27.246z"/>
                                        <path id="path1319" style="stroke-linejoin:round;color:#535353;display:block;stroke:#535353;stroke-linecap:round;stroke-width:3.125;fill:#ffffff" d="m48.361 10.884c0 3.276-2.658 5.935-5.934 5.935s-5.935-2.659-5.935-5.935c0-3.2759 2.659-5.9346 5.935-5.9346s5.934 2.6587 5.934 5.9346z"/>
                                        <path id="path1320" style="stroke-linejoin:round;color:#535353;display:block;stroke:#535353;stroke-linecap:round;stroke-width:3.125;fill:#ffffff" d="m16.557 49.116c0 3.276-2.659 5.935-5.935 5.935-3.2758 0-5.9345-2.659-5.9345-5.935s2.6587-5.935 5.9345-5.935c3.276 0 5.935 2.659 5.935 5.935z"/>
                                        <path id="path2087" style="stroke-linejoin:round;color:#535353;display:block;stroke:#535353;stroke-linecap:round;stroke-width:3.125;fill:#ffffff" d="m55.313 39.992c0 3.276-2.659 5.935-5.935 5.935s-5.935-2.659-5.935-5.935c0-3.275 2.659-5.934 5.935-5.934s5.935 2.659 5.935 5.934z"/>
                                        <path id="path1323" style="stroke-linejoin:round;color:#535353;display:block;stroke:#535353;stroke-linecap:round;stroke-width:3.125;fill:#ffffff" d="m20.773 23.483c0 3.276-2.658 5.935-5.934 5.935s-5.9349-2.659-5.9349-5.935 2.6589-5.934 5.9349-5.934 5.934 2.658 5.934 5.934z"/>
                                      </svg>

                                      <svg *ngIf="layer.type == 'geoLine'" matTooltip="Line" width="22px" height="22px" fill="#535353" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M8.03197 14.5538L14.5538 8.03197C14.2019 7.43645 14 6.74181 14 6C14 3.79086 15.7909 2 18 2C20.2091 2 22 3.79086 22 6C22 8.20914 20.2091 10 18 10C17.2582 10 16.5635 9.79807 15.968 9.44618L9.44618 15.968C9.79807 16.5635 10 17.2582 10 18C10 20.2091 8.20914 22 6 22C3.79086 22 2 20.2091 2 18C2 15.7909 3.79086 14 6 14C6.74181 14 7.43645 14.2019 8.03197 14.5538ZM6 20C7.10457 20 8 19.1046 8 18C8 16.8954 7.10457 16 6 16C4.89543 16 4 16.8954 4 18C4 19.1046 4.89543 20 6 20ZM20 6C20 7.10457 19.1046 8 18 8C16.8954 8 16 7.10457 16 6C16 4.89543 16.8954 4 18 4C19.1046 4 20 4.89543 20 6Z" fill="black"/>
                                        </svg>

                                    <span class="header-3-type text-[#535353]">
                                        &nbsp;&nbsp;{{ layer.name }}
                                    </span>
                                    <svg *ngIf="!layer.isVisible" class="ml-2" xmlns="http://www.w3.org/2000/svg" fill="#535353" matTooltip="Invisible Layer" height="22px" viewBox="0 0 512 512"><path d="M63.998 86.004l21.998-21.998L448 426.01l-21.998 21.998zM259.34 192.09l60.57 60.57a64.07 64.07 0 00-60.57-60.57zM252.66 319.91l-60.57-60.57a64.07 64.07 0 0060.57 60.57z"/><path d="M256 352a96 96 0 01-92.6-121.34l-69.07-69.08C66.12 187.42 39.24 221.14 16 256c26.42 44 62.56 89.24 100.2 115.18C159.38 400.92 206.33 416 255.76 416A233.47 233.47 0 00335 402.2l-53.61-53.6A95.84 95.84 0 01256 352zM256 160a96 96 0 0192.6 121.34L419.26 352c29.15-26.25 56.07-61.56 76.74-96-26.38-43.43-62.9-88.56-101.18-114.82C351.1 111.2 304.31 96 255.76 96a222.92 222.92 0 00-78.21 14.29l53.11 53.11A95.84 95.84 0 01256 160z"/></svg>
                                </mat-panel-title>
                            </mat-expansion-panel-header>  
                            <!-- Table -->
                            <div class="flex flex-col ">
                                <div style="font-size: 14px; font-weight: 300; color: #a0a0a0">
                                    Visual Settings
                                </div>
                                <div (click)="updateVisibility(layer)" class="flex flex-row justify-between border-t px-3 py-1 cursor-pointer hover:bg-gray-200" matTooltip="Click to change visibility">
                                    <span style="font-size: 14px; font-weight: 600">Visibility</span>
                                    <span style="font-size: 14px; font-weight: 400;">{{ layer.isVisible ? 'Visible' : 'Invisible'}}</span>
                                </div>
                                <div class="relative border-t cursor-pointer hover:bg-gray-200" matTooltip="Click to change color" style="height: 29px;">
                                    <div class="absolute flex flex-row w-full justify-between px-3 items-center" style="height: 29px" >
                                        <span style="font-size: 14px; font-weight: 600">Color</span>
                                        <span class=" w-10 border" [style]="'height: 18px; background-color: ' + layer.color"></span>
                                    </div>
                                    <input (change)="updateColor($event, layer.layerID)" type="color" class="w-full h-full absoulte cursor-pointer" style="opacity: 0; height: 29px;">
                                </div>
                                <!--
                                    Not Implemented Yet

                                    <div class="flex flex-row justify-between border-t px-3 py-1" style="height: 29px;">
                                        <span style="font-size: 14px; font-weight: 600">Color by Property</span>
                                        <mat-slide-toggle [(ngModel)]="layer.colorByProperty">{{layer.colorByProperty ? 'ON' : 'OFF'}}</mat-slide-toggle>                            
                                    </div>
                                -->
                                <div *ngIf="layer.type == 'geoPoint'" class="flex flex-row justify-between border-t px-3 py-1" style="height: 29px;">
                                    <span style="font-size: 14px; font-weight: 600">Point Size</span>
                                    <div class="flex">
                                        <mat-slider min="1"
                                        max="40"
                                        step="1"
                                        (change)="sliderChanged( layer )"
                                        [(ngModel)]="layer.size"></mat-slider>
                                        <div style="width:25px">
                                            {{layer.size}}px                              
                                        </div>
                                    </div>
                                 </div>
                                 <div class="flex flex-row justify-between border-t px-3 py-1" style="height: 29px;">
                                    <span style="font-size: 14px; font-weight: 600">Opacity</span>
                                    <div class="flex">
                                        <mat-slider min="0"
                                        max="1"
                                        step="0.01"
                                        (change)="sliderChanged( layer )"
                                        [(ngModel)]="layer.opacity"
                                        ></mat-slider>
                                        <div style="width:25px">
                                            {{formatPercent(layer.opacity)}}                  
                                        </div>
                                    </div>
                                </div>
                                <div *ngIf="layer.type == 'geoPoint'" (click)="updatePointType(layer)" class="flex flex-row justify-between border-t px-3 py-1 cursor-pointer hover:bg-gray-200" matTooltip="Click to change point type">
                                    <span style="font-size: 14px; font-weight: 600">Point Type</span>
                                    <span style="font-size: 14px; font-weight: 400;">{{ layer.pointType == 1 ? 'Circle' : layer.pointType == 2 ? 'Square' : 'Triangle'}}</span>
                                </div>
                            </div>
                            <div class="flex flex-col mt-2">
                                <div style="font-size: 14px; font-weight: 300; color: #a0a0a0">
                                    Layer Information
                                </div>
                                <div class="flex flex-row justify-between border-t px-3 py-1">
                                    <span style="font-size: 14px; font-weight: 600">Database</span>
                                    <span style="font-size: 14px; font-weight: 400;">{{ databases[layer.selectedDatabase].name }}</span>
                                </div>
                                <div class="flex flex-row justify-between border-t px-3 py-1">
                                    <span style="font-size: 14px; font-weight: 600">Query Type</span>
                                    <span style="font-size: 14px; font-weight: 400;">{{ layer.queryType }}</span>
                                </div>
                                <div class="flex flex-row justify-between border-t px-3 py-1">
                                    <span style="font-size: 14px; font-weight: 600">Feature</span>
                                    <span style="font-size: 14px; font-weight: 400;">{{ layer.featuresOrItems[layer.selectedFeature].frontendName }}</span>
                                </div>
                                <div class="flex flex-row justify-between border-t px-3 py-1">
                                    <span style="font-size: 14px; font-weight: 600">Number of Results</span>
                                    <svg *ngIf="layer.data.rowCount === null" matTooltip="Available after the query is run" xmlns="http://www.w3.org/2000/svg" height="20px" fill="#535353" viewBox="0 0 512 512"><path d="M288.55 150.84c-8.09-3.86-20-6-32.72-5.82-18 .22-33.13 5.2-45 14.78-23 18.48-24.55 40.37-24.77 42.8a61.69 61.69 0 00-.09 12 3 3 0 003 2.69h21.23a3 3 0 003-3A65.7 65.7 0 01214 204c0-.11 1.14-11.7 14.36-22.34 7-5.64 16.11-8.44 27.83-8.59 9.32-.11 16.93 1.47 20.34 3.09C291 183 298 192.31 298 204.57c0 18-10.9 26.23-30.18 39.18C247.08 257.68 237 275.1 237 297v11a3 3 0 003 3h22a3 3 0 003-3v-11c0-9.16 2.23-19.13 18.44-30 19.95-13.41 42.56-28.6 42.56-62.43 0-23.14-13.3-42.23-37.45-53.73z" fill="none"/><path d="M256 64C150 64 64 150 64 256s86 192 192 192 192-86 192-192S362 64 256 64zm10.44 302h-30.21a2.57 2.57 0 01-2.56-2.57v-30.2a2.57 2.57 0 012.56-2.57h30.21a2.57 2.57 0 012.56 2.57v30.2a2.57 2.57 0 01-2.56 2.57zm17-99C267.23 277.88 265 287.85 265 297v11a3 3 0 01-3 3h-22a3 3 0 01-3-3v-11c0-21.91 10.08-39.33 30.82-53.26C287.1 230.8 298 222.6 298 204.57c0-12.26-7-21.57-21.49-28.46-3.41-1.62-11-3.2-20.34-3.09-11.72.15-20.82 2.95-27.83 8.59C215.12 192.25 214 203.84 214 204a65.7 65.7 0 00-.84 10.28 3 3 0 01-3 3h-21.25a3 3 0 01-3-2.69 61.69 61.69 0 01.09-12c.22-2.43 1.8-24.32 24.77-42.8 11.91-9.58 27.06-14.56 45-14.78 12.7-.15 24.63 2 32.72 5.82 24.21 11.51 37.51 30.6 37.51 53.74 0 33.83-22.61 49.02-42.56 62.43z"/></svg>
                                    <span *ngIf="layer.data.rowCount !== null" style="font-size: 14px; font-weight: 400;">{{ layer.data.rowCount }}</span>
                                </div>
                                <div class="flex flex-row justify-between border-t px-3 py-1">
                                    <span style="font-size: 14px; font-weight: 600">Status</span>
                                    <span style="font-size: 14px; font-weight: 400;">{{ !layer.hasQueried ? 'Not queried yet' : layer.isQuerying ? 'Waiting for database' : layer.queryError !== null ? 'Query Error, see Run Control' : layer.isRendering ? 'Rendering map' : 'Rendered' }}</span>
                                </div>
                            </div>
                            <!-- Query Builder -->
                            <div style="font-size: 14px; font-weight: 300; color: #a0a0a0" class=" mt-2">
                                Query Builder
                            </div>
                            <div [id]="'map-builder-global' + layer.layerID"></div>
                            <!-- Remove -->
                            <div class="flex flex-row justify-between mt-2 -mb-1">
                                <button (click)="layer.isExpanded = false" class="standard-button border py-1 px-2" mat-button>
                                    <span class="standard-button-text">
                                        Minimize Layer
                                    </span>
                                </button>
                                <button (click)="removeLayer(layer)" class="red-button border py-1 px-2" mat-button>
                                    <span class="red-button-text">
                                        Remove Layer
                                    </span>
                                </button>
                            </div>
                        </mat-expansion-panel>
                        <div class="flex flex-row justify-start" style="margin-top: 16px">
                            <button (click)="expandAllLayers(true)" class="standard-button border p-2 mr-3" mat-button>
                                <span class="standard-button-text">
                                    Expand All
                                </span>
                            </button>
                            <button (click)="expandAllLayers(false)" class="standard-button border p-2" mat-button>
                                <span class="standard-button-text">
                                    Collapse All
                                </span>
                            </button>
                        </div>
                    </div>
                    <div *ngIf="queryState.mapView.layers.length == 0" class="flex flex-row justify-center" matTooltip="Use the Data Selector to add a layer">
                        No layers selected
                    </div>
                </mat-expansion-panel>

                <!-- Table View -->
                <mat-expansion-panel *ngIf="viewType == 1" [(expanded)]="expandedPanelLookup['table-builder']">
                    <mat-expansion-panel-header>
                        <mat-panel-title>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="#535353" height="22px" viewBox="0 0 512 512"><title>Filter</title><path d="M16 120h480v48H16zM96 232h320v48H96zM192 344h128v48H192z"/></svg>
                            <span class="header-3-type text-[#535353]">
                                &nbsp;&nbsp;Filter
                            </span>
                        </mat-panel-title>
                    </mat-expansion-panel-header>  
                    <div id="table-builder"></div>               
                </mat-expansion-panel>
                <mat-expansion-panel *ngIf="viewType == 1"  class="mt-3">
                    <mat-expansion-panel-header>
                        <mat-panel-title>
                                <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="22px" height="22px" viewBox="0 0 512.000000 512.000000" preserveAspectRatio="xMidYMid meet">

                                    <g transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)" fill="#535353" stroke="none">
                                    <path d="M2295 5114 c-596 -29 -1047 -99 -1348 -208 -169 -61 -284 -134 -336 -213 l-31 -47 2 -250 3 -249 732 -461 732 -461 1 -800 c0 -829 0 -825 39 -825 25 0 995 300 1006 311 6 6 11 244 13 662 l2 653 722 454 c397 250 727 461 735 468 10 10 13 66 13 245 0 271 -3 281 -92 363 -180 164 -654 286 -1322 339 -174 14 -727 26 -871 19z m820 -219 c424 -29 759 -83 945 -154 178 -68 170 -117 -31 -177 -407 -123 -835 -174 -1464 -174 -616 0 -1154 59 -1460 160 -101 34 -149 59 -164 89 -40 73 286 174 729 227 378 44 1027 57 1445 29z"/>
                                    <path d="M844 2186 c-18 -14 -19 -35 -24 -639 l-5 -624 -260 103 c-143 57 -270 104 -282 104 -37 0 -48 -35 -24 -73 12 -18 197 -261 414 -542 330 -429 396 -510 417 -510 21 0 87 82 417 510 217 281 403 524 414 542 24 38 13 73 -24 73 -12 -1 -139 -47 -282 -104 l-260 -103 -5 624 c-5 604 -6 625 -24 639 -29 21 -443 21 -472 0z"/>
                                    <path d="M4012 2183 c-16 -14 -711 -916 -801 -1039 -19 -26 -21 -35 -12 -53 7 -12 21 -21 36 -21 13 0 137 45 276 100 140 55 257 100 261 100 5 0 8 -279 8 -619 0 -550 2 -621 16 -635 13 -14 49 -16 242 -16 126 0 234 5 242 10 13 8 15 92 18 636 2 588 4 626 20 621 9 -2 127 -48 260 -101 134 -53 254 -96 268 -96 26 0 49 33 38 53 -19 32 -799 1044 -816 1060 -11 9 -24 17 -28 17 -4 0 -17 -8 -28 -17z"/>
                                    </g>
                                    </svg>
                            <span class="header-3-type text-[#535353]">
                                &nbsp;&nbsp;Sort
                            </span>
                        </mat-panel-title>
                    </mat-expansion-panel-header>
                    <div class="flex flex-row items-center">
                        <mat-form-field appearance="fill" style="margin-top: 10px; margin-bottom: -10px; font-size: 0.9rem">
                            <mat-label>Select Field</mat-label>
                            <mat-select [(ngModel)]="queryState.tableView.selectedSortField">
                                <mat-option *ngFor="let obj of queryState.tableView.currentReturnableIDs; index as i" [value]="i">{{ queryState.tableView.currentColumnObjects[i].frontendName }}</mat-option>
                            </mat-select>
                        </mat-form-field>  

                        <mat-radio-group aria-label="Select an option" [(ngModel)]="queryState.tableView.filterBy" class="flex flex-col ml-2">
                            <mat-radio-button style="margin-right: 5px" value="Ascending">Ascending</mat-radio-button>
                            <mat-radio-button value="Descending">Descending</mat-radio-button>
                        </mat-radio-group>
                        
                        <button class="standard-button border p-2 ml-auto" mat-button (click)="queryState.tableView.selectedSortField=null">
                            <span class="standard-button-text">
                                Clear
                            </span>
                        </button>
                    </div>
                </mat-expansion-panel>
            </div>
            
        </div>
        
        <!-- Run Control -->
        <div style="box-shadow: -4px 0 8px -2px rgb(138, 138, 138); z-index: 2;" [class.w-2-7]="isL && viewType == 1" [class.w-full]="!isL || viewType == 2" class="bg-white">
            <!-- Header -->
            <div *ngIf="viewType == 2 || !isL" [class.top-0]="viewType == 2 && isL" [class.top-49]="!isL" [class.border-l]="!isSm && !isXs" class="flex flex-row items-center bg-white px-4 h-14 min-h-14 sticky" style="box-shadow: 0px 4px 8px -4px rgb(138, 138, 138); z-index: 2;">
                <svg class="cursor-pointer" (click)="scrollToTop()" xmlns="http://www.w3.org/2000/svg" height="30px" fill="#569CD7" viewBox="0 0 512 512"><path d="M96 448l320-192L96 64v384z"/></svg>
                <span class="pl-2 header-type text-[#569CD7]">Run Control</span>
            </div>
            <div class=" w-full h-full flex flex-col p-3">
            <!-- Run Query Box -->
            <div class="w-full flex flex-col items-center">
                <button id="run-query" style="width: 75%" class="apply-button text-semibold py-2 mt-4 flex flex-row justify-center" mat-button (click)="queryDatabase()">
                    <svg xmlns="http://www.w3.org/2000/svg" height="22px" fill="#5fa784" viewBox="0 0 512 512"><title>Search Circle</title><path d="M256 64C150.13 64 64 150.13 64 256s86.13 192 192 192 192-86.13 192-192S361.87 64 256 64zm80 294.63l-54.15-54.15a88.08 88.08 0 1122.63-22.63L358.63 336z"/><circle cx="232" cy="232" r="56"/></svg>
                    <span class="apply-button-text">
                        &nbsp;&nbsp;RUN QUERY
                    </span>
                </button>
                <!-- Query Status Box -->
                <!-- Table View -->
                <div *ngIf="viewType == 1">
                    <div *ngIf="queryState.tableView.queryTime !== null && queryState.tableView.progressBarMode === 'determinate'" class="result-text">
                        <p *ngIf="queryState.tableView.invalidQuery && queryState.tableView.queryError === 'queryBuilder'" ><span style="color: #f99;" class="cache-text" matTooltip="Check Query Builder">Invalid Query</span></p>
                        <p *ngIf="!queryState.tableView.invalidQuery && queryState.tableView.queryError === null">{{queryTime}}ms <span *ngIf="queryState.tableView.data.isCached" class="cache-text" matTooltip="Results stored in memory">Cached</span></p>
                        <p *ngIf="queryState.tableView.queryError !== null"><span style="color: #f99;" class="cache-text" matTooltip="Try again later or change the query">Error: {{ queryState.tableView.queryError }}</span></p>
                    </div>
                </div>
                <!-- Map View -->
                <div *ngIf="viewType == 2" class="result-text">
                    <p *ngIf="getAllLayersStatus(0)" style="color:rgb(138, 138, 138)">
                        {{getAllLayersStatus(0)}}
                    </p>
                    <p *ngFor="let obj of getAllLayersStatus(1)" style="color:rgb(138, 138, 138)">
                        <span style="font-weight: bold;">{{obj.name}}:</span> Querying Database...
                    </p>
                    <p *ngFor="let obj of getAllLayersStatus(2)" >
                        <span style="color: #f99;" class="cache-text" matTooltip="Check Query Builder"><span style="font-weight: bold;">{{obj.name}}:</span> Invalid Query</span>
                    </p>
                    <p *ngFor="let obj of getAllLayersStatus(3)">
                        <span style="font-weight: bold;">{{obj.name}}:</span> {{obj.queryTime}}ms <span *ngIf="obj.data.isCached" class="cache-text" matTooltip="Results served from memory">from Cache</span><span *ngIf="obj.data.isCached === false" class="cache-text" matTooltip="Results computed in PostgreSQL">from Database</span>
                    </p>
                    <p *ngFor="let obj of getAllLayersStatus(4)">
                        <span style="color: #f99"><span style="font-weight: bold;">{{obj.name}}:</span> Error: </span><span style="color: #f99; text-decoration-color: #f99;" class="cache-text" matTooltip="Try again later or change the query">{{ obj.queryError }}</span>
                    </p>
                </div>
            </div>
                <!-- Utils Divider -->
                <div class="-mx-3 header-2-type flex flex-row my-3 items-center text-[#a0a0a0] pl-4 pt-3">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="#a0a0a0" height="22px" viewBox="0 0 512 512"><title>Build</title><path d="M230 209.2L32 405.58 106.65 480l197.59-198.17c46.47 17.46 105.52 12.54 143-24.78 40.44-40.32 40.35-108 16.81-156.79l-87.33 87.06-52.32-52.13 87.33-87.06C363 24.46 294.67 24.34 254.23 64.66c-38.03 37.91-42.78 97.6-24.23 144.54z"/></svg>
                    &nbsp;&nbsp;Utilities
                </div>
                <button (click)="queryDatabase(true)" id="utility" class="utility-button w-full border p-3 inline" mat-button >
                    <svg xmlns="http://www.w3.org/2000/svg" fill="#569CD7" height="22px" viewBox="0 0 512 512"><path xmlns="http://www.w3.org/2000/svg" d="M472.7 189.5c-15.76-10-36.21-16.79-58.59-19.54-6.65-39.1-24.22-72.52-51.27-97.26C334.15 46.45 296.21 32 256 32c-35.35 0-68 11.08-94.37 32a149.7 149.7 0 00-45.29 60.42c-30.67 4.32-57 14.61-76.71 30C13.7 174.83 0 203.56 0 237.6 0 305 55.92 352 136 352h104V208h32v144h124c72.64 0 116-34.24 116-91.6 0-30.05-13.59-54.57-39.3-70.9zM240 419.42L191.98 371l-22.61 23L256 480l86.63-86-22.61-23L272 419.42V352h-32v67.42z"/></svg>
                    <span class="header-3-type text-[#569CD7] m-auto">
                        &nbsp;&nbsp;Download {{viewType == 1 ? 'Table' : 'Map'}} Data
                    </span>
                </button>
                <!--
                <button id="utility" class="mt-2 utility-button w-full border p-3 inline" mat-button >
                    <svg xmlns="http://www.w3.org/2000/svg" fill="#569CD7" height="22px" viewBox="0 0 512 512"><path xmlns="http://www.w3.org/2000/svg" d="M200.66 352H144a96 96 0 010-192h55.41M312.59 160H368a96 96 0 010 192h-56.66M169.07 256h175.86" fill="none" stroke="currentColor" stroke-linecap="square" stroke-linejoin="round" stroke-width="48"/></svg>
                    <span class="header-3-type text-[#569CD7] m-auto">
                        &nbsp;&nbsp;Save Link to {{viewType == 1 ? 'Query' : 'Map'}}
                    </span>
                </button>
                -->
                <button (click)="saveMapImage()" [disabled]="savingImage" *ngIf="viewType == 2" id="utility" class="mt-2 utility-button w-full border p-3 inline" mat-button >
                    <svg xmlns="http://www.w3.org/2000/svg" fill="#569CD7" height="22px" viewBox="0 0 512 512"><path xmlns="http://www.w3.org/2000/svg" d="M456 144h-83c-3 0-6.72-1.94-9.62-5L336.1 96.2C325 80 320 80 302 80h-92c-18 0-24 0-34.07 16.21L148.62 139c-2.22 2.42-5.34 5-8.62 5v-16a8 8 0 00-8-8H92a8 8 0 00-8 8v16H56a24 24 0 00-24 24v240a24 24 0 0024 24h400a24 24 0 0024-24V168a24 24 0 00-24-24zM260.51 367.9a96 96 0 1191.39-91.39 96.11 96.11 0 01-91.39 91.39z"/></svg>
                    <span class="header-3-type text-[#569CD7] m-auto">
                        &nbsp;&nbsp;{{ savingImage ? 'Loading...' : 'Save Image of Map' }}
                    </span>
                </button>
                <!-- 
                <button id="utility" class="mt-2 utility-button w-full border p-3 inline" mat-button >
                    <svg xmlns="http://www.w3.org/2000/svg" fill="#569CD7" height="22px" viewBox="0 0 512 512"><path xmlns="http://www.w3.org/2000/svg" d="M256 48C141.13 48 48 141.13 48 256c0 114.69 93.32 208 208 208 114.86 0 208-93.14 208-208 0-114.69-93.31-208-208-208zm108 240H244a4 4 0 01-4-4V116a4 4 0 014-4h24a4 4 0 014 4v140h92a4 4 0 014 4v24a4 4 0 01-4 4z"/></svg>
                    <span class="header-3-type text-[#569CD7] m-auto">
                        &nbsp;&nbsp;Query History
                    </span>
                </button>
                -->
            </div>
        </div>
        </div>

    </div>
    <!-- Table -->
    <div [hidden]="viewType === 2" class="bg-white w-full py-6 border-t border-[#569CD7]" style="z-index:5; position: relative;" [class.px-6]="!isXs">
        <div style="box-shadow: 0 5px 5px -3px #0003,0 8px 10px 1px #00000024,0 3px 14px 2px #0000001f;" class="bg-white ">
            <mat-progress-bar [mode]="queryState.tableView.progressBarMode" [value]="queryState.tableView.progressBarValue" class="mat-progress-bar-buffer"></mat-progress-bar>
            <div class="overflow-x-scroll">
                <table class=" ">
                    <!-- Heaader -->
                    <tr class="h-70px text-gray-700   text-sm ">
                        <th *ngFor="let header of queryState.tableView.data.headerNames" class="w-1000px  pl-8 text-left min-w-150px">{{ header }}</th>
                    </tr>
                    <!-- Data -->
                    <tr *ngFor="let row of queryState.tableView.data.tableData; index as i" class="h-50px text-sm hover-bg-gray-100">
                        <td *ngFor="let cell of [queryState.tableView.data.primaryKeys[i]].concat(row)" class="border-t border-gray-200   w-1000px  pl-8 text-left min-w-150px">{{ cell }}</td>
                    </tr>
                </table>
            </div>
            <div class="flex justify-between">
                
                <div [class.mt-4]="isXs" [class.flex-col]="isXs" [class.flex-row]="!isXs" class="flex items-center">
                    <button [class.mb-2]="isXs" class="text-semibold bg-[#569CD7] px-2 mx-2 text-sm" style="height: 25px;" mat-button (click)="queryDatabase(true)">{{ isDownloading ? 'Downloading...' : 'Download all pages' }}</button>
                    <div>
                        <mat-radio-group class="flex flex-row text-sm" aria-label="Select an option" [(ngModel)]="downloadType">
                          <mat-radio-button style="margin-right: 5px" value="csv">CSV</mat-radio-button>
                          <mat-radio-button value="json">JSON</mat-radio-button>
                        </mat-radio-group>
                    </div>
                </div>
                <mat-paginator *ngIf="viewType == 1" #paginator [length]="queryState.tableView.data.rowCount"
                    [pageSize]="queryState.tableView.currentPageSize"
                    [pageSizeOptions]="[10, 25, 100, 1000]"
                    (page)="onPageChange($event, 1)"
                    aria-label="Select page">
                </mat-paginator>
            </div>
    </div>
    

    </div>
    <!-- Map -->
    <div [hidden]="viewType === 1" [class.w-full]="!isL" [class.w-5-7]="isL" class="relative" >
        <!-- Snap to ... Button-->
        <div *ngIf="!isL" class="absolute top-3 w-full flex flex-row justify-center">
            <button (click)="snapTo(currentlySnappedTo)" class="rounded-full shadow-lg px-3 py-2 bg-white text-[#569CD7] w-[200px] flex flex-row" style="z-index: 402;">
                <svg xmlns="http://www.w3.org/2000/svg" [class.toggle-down]="currentlySnappedTo == 0" [class.toggle-up]="currentlySnappedTo == 1" style="width: 25%;" height="22px" viewBox="0 0 512 512"><path fill="none" stroke="currentColor" stroke-linecap="square" stroke-miterlimit="10" stroke-width="48" d="M112 268l144 144 144-144M256 392V100"/></svg>
                <span style="width: 75%; font-weight: 600; font-size: 14px;">Snap to {{currentlySnappedTo == 0 ? 'Map' : 'Controls'}}</span>
            </button>
        </div>
        <!-- Basemap -->
        <button matTooltip="Click to change basemap" matTooltipPosition="left" mat-button [matMenuTriggerFor]="menu" class="border border-[#535353] absolute top-3 right-14" style="font-size: 0.9rem; margin: auto; z-index: 401; padding: 6px 12px;background-color: #fff;color: #535353;">Basemap</button>
        <mat-menu class="absolute top-14 right-14" #menu="matMenu" style="font-size: 0.9rem; z-index: 401">
            <button *ngFor="let key of basemapLayersArray" mat-menu-item (click)="onBasemapChange(key)">
                <span [class.font-bold]="selectedBasemapKey == key" [class.underline]="selectedBasemapKey == key" style="font-size: 0.9rem; color: #535353; margin: 10px;">
                    {{ basemapLayers[key].name }}
                </span>
            </button>
        </mat-menu>

        <!-- Map Setting dropdown -->
        <!--
        <div class="absolute w-full flex flex-row" [class.justify-center]="isSm || isXs" [class.justify-left]="!isSm && !isXs" [class.top-3]="!isSm && !isXs" [class.top-14]="isSm || isXs">
            <mat-expansion-panel style="z-index: 401; width: 285px; border-radius: 20px;" class="ml-3" [(expanded)]="isMapSettingsExpanded">
                <mat-expansion-panel-header>
                    <mat-panel-title>
                        <svg xmlns="http://www.w3.org/2000/svg" height="22px" fill="#535353" viewBox="0 0 512 512"><path d="M464 249.93a10.58 10.58 0 00-9.36-9.94L429 235.84a5.42 5.42 0 01-4.5-4.67c-.49-3.15-1-6.42-1.7-9.52a5.52 5.52 0 012.63-5.85l22.78-12.65a10.35 10.35 0 005-12.83l-3.95-10.9a10.32 10.32 0 00-12.13-6.51l-25.55 5a5.5 5.5 0 01-5.82-2.81c-1.49-2.79-3.11-5.63-4.8-8.42a5.6 5.6 0 01.44-6.5l17-19.63a10.44 10.44 0 00.39-13.77l-7.42-8.91a10.24 10.24 0 00-13.58-2l-22.37 13.43a5.39 5.39 0 01-6.39-.63c-2.47-2.17-4.95-4.26-7.37-6.19a5.45 5.45 0 01-1.72-6.21l9.26-24.4a10.35 10.35 0 00-4.31-13.07l-10.08-5.85a10.31 10.31 0 00-13.46 2.83L325 96.28a4.58 4.58 0 01-5.6 1.72c-.62-.25-5.77-2.36-9.78-3.7a5.42 5.42 0 01-3.74-5.23l.39-26.07a10.48 10.48 0 00-8.57-10.88l-11.45-2a10.45 10.45 0 00-11.75 7.17L266 82.1a5.42 5.42 0 01-5.36 3.65h-9.75a5.53 5.53 0 01-5.3-3.67l-8.46-24.67a10.46 10.46 0 00-11.77-7.25l-11.46 2a10.46 10.46 0 00-8.57 10.79l.4 26.16a5.45 5.45 0 01-3.86 5.25c-2.28.89-7.26 2.78-9.51 3.63-2 .72-4.19-.07-6-2.1l-16.26-20A10.3 10.3 0 00156.69 73l-10.06 5.83A10.36 10.36 0 00142.31 92l9.25 24.34a5.54 5.54 0 01-1.7 6.23c-2.43 2-4.92 4-7.4 6.22a5.38 5.38 0 01-6.35.64L114 115.74a10.39 10.39 0 00-13.61 2l-7.4 8.9a10.32 10.32 0 00.37 13.76l17.09 19.6a5.42 5.42 0 01.45 6.45c-1.71 2.72-3.34 5.58-4.82 8.44a5.53 5.53 0 01-5.86 2.82l-25.51-4.93a10.34 10.34 0 00-12.14 6.51l-4 10.88a10.37 10.37 0 005 12.85l22.78 12.65a5.39 5.39 0 012.65 5.92l-.23 1.24c-.53 2.8-1 5.45-1.47 8.27a5.48 5.48 0 01-4.46 4.64l-25.7 4.15A10.42 10.42 0 0048 250.16v11.58A10.26 10.26 0 0057.16 272l25.68 4.14a5.41 5.41 0 014.5 4.67c.49 3.16 1 6.42 1.7 9.52a5.52 5.52 0 01-2.63 5.85l-22.77 12.67a10.35 10.35 0 00-5 12.83l4 10.9a10.33 10.33 0 0012.13 6.51l25.55-4.95a5.5 5.5 0 015.82 2.81c1.5 2.8 3.12 5.64 4.8 8.42a5.58 5.58 0 01-.44 6.5l-17 19.64a10.41 10.41 0 00-.5 13.76l7.41 8.91a10.24 10.24 0 0013.58 2l22.37-13.43a5.39 5.39 0 016.39.63c2.48 2.17 5 4.26 7.37 6.19a5.45 5.45 0 011.72 6.21l-9.26 24.4a10.35 10.35 0 004.31 13.07l10.11 5.84a10.3 10.3 0 0013.45-2.82L187 415.92c1.39-1.73 3.6-2.5 5.24-1.84 3.47 1.44 5.8 2.25 9.93 3.63a5.44 5.44 0 013.75 5.23l-.4 26.05a10.5 10.5 0 008.57 10.88l11.45 2a10.44 10.44 0 0011.75-7.17l8.5-24.77a5.48 5.48 0 015.36-3.65h9.75a5.52 5.52 0 015.3 3.67l8.47 24.67a10.48 10.48 0 0010 7.41 9.74 9.74 0 001.78-.16l11.47-2a10.46 10.46 0 008.56-10.79l-.4-26.16a5.43 5.43 0 013.75-5.2c3.84-1.29 6.53-2.33 8.91-3.24l.6-.24c3.06-1.06 4.53.14 5.47 1.31l16.75 20.63A10.3 10.3 0 00355 439l10.07-5.83a10.35 10.35 0 004.31-13.1l-9.24-24.34a5.52 5.52 0 011.69-6.23c2.43-2 4.92-4 7.4-6.22a5.39 5.39 0 016.38-.62l22.39 13.4a10.39 10.39 0 0013.61-2l7.4-8.9a10.31 10.31 0 00-.37-13.75l-17.06-19.67a5.42 5.42 0 01-.45-6.45c1.71-2.71 3.34-5.57 4.82-8.44a5.56 5.56 0 015.86-2.82l25.48 4.97a10.34 10.34 0 0012.14-6.51l3.95-10.88a10.36 10.36 0 00-5-12.84l-22.8-12.67a5.4 5.4 0 01-2.61-5.89l.23-1.25c.53-2.8 1-5.44 1.47-8.26a5.48 5.48 0 014.46-4.64l25.7-4.14a10.43 10.43 0 009.17-10.28v-11.71zM171.59 361.27a135.12 135.12 0 01.5-210.94l60 105.61zM256 391.11a133.75 133.75 0 01-48.49-9.05L268 276.79h121.22C379.21 341.45 323.29 391.11 256 391.11zm12.06-155.9l-59.95-105.5a133.87 133.87 0 0147.89-8.82c67.29 0 123.21 49.66 133.22 114.32z"/></svg>
                        <span style="font-weight: 600; font-size: 14px; color: #535353">&nbsp;&nbsp;{{isMapSettingsExpanded ? 'Close' : 'Open'}} Map Settings</span>
                    </mat-panel-title>
                </mat-expansion-panel-header>  
                <div class="flex flex-row items-center bg-white pr-2 py-3">
                    <svg xmlns="http://www.w3.org/2000/svg" matTooltip="Basemap" style="flex-shrink: 0;" class="mr-4" height="22px" fill="#535353" viewBox="0 0 512 512"><ellipse cx="373.14" cy="219.33" rx="46.29" ry="46" fill="none"/><path d="M80 132v328a20 20 0 0020 20h392a20 20 0 0020-20V132a20 20 0 00-20-20H100a20 20 0 00-20 20zm293.14 41.33a46 46 0 11-46.28 46 46.19 46.19 0 0146.28-46zm-261.41 276v-95.48l122.76-110.2L328.27 337l-113 112.33zm368.27 0H259l144.58-144L480 370.59z"/><path d="M20 32A20 20 0 000 52v344a20 20 0 0020 20h28V100a20 20 0 0120-20h380V52a20 20 0 00-20-20z"/></svg>
                    <mat-form-field appearance="fill" style="margin-bottom: -21px; font-size: 0.9rem">
                        <mat-label>Select Basemap</mat-label>
                        <mat-select [(ngModel)]="selectedBasemapKey" (ngModelChange)="onBasemapChange()">
                        <mat-option *ngFor="let key of basemapLayersArray" [value]="key">{{ basemapLayers[key].name }}</mat-option>
                        </mat-select>
                    </mat-form-field>              
                </div>
            </mat-expansion-panel>


            
        </div>
        -->
        <div id="map" style="height: calc(100vh - 49px)"></div>
    </div>
</div>