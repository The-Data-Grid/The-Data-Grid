<mat-sidenav-container class="sidenav-container">
    <mat-sidenav class="sidenav" mode="side" opened fxLayout="column" fxLayoutAlign="space-between center">
        <h3>Filter By</h3>
        <mat-radio-group style="padding-top: 30px" aria-label="Select an option" [(ngModel)]="filterBy">
            <mat-radio-button value="Submission">Submission</mat-radio-button>
            <mat-radio-button value="Feature">Feature</mat-radio-button>
        </mat-radio-group>

        <!-- global filters -->
        <div class="global-filters" style="padding-top: 10px;">
            <h3>Global Filters</h3>
            <div *ngIf="selectorsLoaded">
                <div *ngFor="let info of globalSelectors['numericChoice']">
                    <ng-template *ngTemplateOutlet="numericChoiceTemplate; context: {$implicit: info}">
                    </ng-template>
                </div>
                <div *ngFor="let info of globalSelectors['numericEqual']">
                    <ng-template *ngTemplateOutlet="numericEqualTemplate; context: {$implicit: info}">
                    </ng-template>
                </div>
                <div *ngFor="let info of globalSelectors['calendarRange']">
                    <ng-template *ngTemplateOutlet="calendarRangeTemplate; context: {$implicit: info}">
                    </ng-template>
                </div>
                <div *ngFor="let info of globalSelectors['calendarEqual']">
                    <ng-template *ngTemplateOutlet="calendarEqualTemplate; context: {$implicit: info}">
                    </ng-template>
                </div>
                <div *ngFor="let info of globalSelectors['dropdown']">
                    <ng-template *ngTemplateOutlet="dropdownTemplate; context: {$implicit: info}">
                    </ng-template>
                </div>
                <div *ngFor="let info of globalSelectors['searchableDropdown']">
                    <ng-template *ngTemplateOutlet="searchableDropdownTemplate; context: {$implicit: info}">
                    </ng-template>
                </div>
                <div *ngFor="let info of globalSelectors['checklistDropdown']">
                    <ng-template *ngTemplateOutlet="checklistDropdownTemplate; context: {$implicit: info}">
                    </ng-template>
                </div>
                <div *ngFor="let info of globalSelectors['searchableChecklistDropdown']">
                    <ng-template *ngTemplateOutlet="searchableChecklistDropdownTemplate; context: {$implicit: info}">
                    </ng-template>
                </div>
                <div *ngFor="let info of globalSelectors['text']">
                    <ng-template *ngTemplateOutlet="textTemplate; context: {$implicit: info}">
                    </ng-template>
                </div>
                <div *ngFor="let info of globalSelectors['bool']">
                    <ng-template *ngTemplateOutlet="boolTemplate; context: {$implicit: info}">
                    </ng-template>
                </div>
            </div>
        </div>

        <!-- feature filters -->
        <div class="features-filters" *ngIf="filterBy!='Submission'">
            <h3>Feature Filters</h3>
            <mat-form-field>
                <mat-label>Features</mat-label>
                <mat-select [(ngModel)]="selectedFeature">
                    <mat-option *ngFor="let info of rootFeatures" [value]="info">
                        {{info.name}}
                    </mat-option>
                </mat-select>
            </mat-form-field>

            <mat-accordion *ngIf="selectedFeature">
                <mat-expansion-panel>
                    <mat-expansion-panel-header>
                        <mat-panel-title>{{selectedFeature.name}}</mat-panel-title>
                    </mat-expansion-panel-header>
                    <div *ngFor="let column of featureSelectors[selectedFeature.index].numericChoice">
                        <ng-template *ngTemplateOutlet="numericChoiceTemplate; context: {$implicit: column}">
                        </ng-template>
                    </div>
                    <div *ngFor="let column of featureSelectors[selectedFeature.index].numericEqual">
                        <ng-template *ngTemplateOutlet="numericEqualTemplate; context: {$implicit: column}">
                        </ng-template>
                    </div>
                    <div *ngFor="let column of featureSelectors[selectedFeature.index].calendarRange">
                        <ng-template *ngTemplateOutlet="calendarRangeTemplate; context: {$implicit: column}">
                        </ng-template>
                    </div>
                    <div *ngFor="let column of featureSelectors[selectedFeature.index].calendarEqual">
                        <ng-template *ngTemplateOutlet="calendarEqualTemplate; context: {$implicit: column}">
                        </ng-template>
                    </div>
                    <div *ngFor="let column of featureSelectors[selectedFeature.index].dropdown">
                        <ng-template *ngTemplateOutlet="dropdownTemplate; context: {$implicit: column}">
                        </ng-template>
                    </div>
                    <div *ngFor="let column of featureSelectors[selectedFeature.index].searchableDropdown">
                        <ng-template *ngTemplateOutlet="searchableDropdownTemplate; context: {$implicit: column}">
                        </ng-template>
                    </div>
                    <div *ngFor="let column of featureSelectors[selectedFeature.index].checklistDropdown">
                        <ng-template *ngTemplateOutlet="checklistDropdownTemplate; context: {$implicit: column}">
                        </ng-template>
                    </div>
                    <div *ngFor="let column of featureSelectors[selectedFeature.index].searchableChecklistDropdown">
                        <ng-template
                            *ngTemplateOutlet="searchableChecklistDropdownTemplate; context: {$implicit: column}">
                        </ng-template>
                    </div>
                    <div *ngFor="let column of featureSelectors[selectedFeature.index].text">
                        <ng-template *ngTemplateOutlet="textTemplate; context: {$implicit: column}">
                        </ng-template>
                    </div>
                    <div *ngFor="let column of featureSelectors[selectedFeature.index].bool">
                        <ng-template *ngTemplateOutlet="boolTemplate; context: {$implicit: column}">
                        </ng-template>
                    </div>
                </mat-expansion-panel>
                <mat-expansion-panel *ngFor="let childIndex of featuresToChildren[selectedFeature.index]">
                    <mat-expansion-panel-header>
                        <mat-panel-title>
                            {{setupObject.features[childIndex].frontendName}}
                        </mat-panel-title>
                    </mat-expansion-panel-header>
                    <div *ngFor="let column of featureSelectors[childIndex].numericChoice">
                        <ng-template *ngTemplateOutlet="numericChoiceTemplate; context: {$implicit: column}">
                        </ng-template>
                    </div>
                    <div *ngFor="let column of featureSelectors[childIndex].numericEqual">
                        <ng-template *ngTemplateOutlet="numericEqualTemplate; context: {$implicit: column}">
                        </ng-template>
                    </div>
                    <div *ngFor="let column of featureSelectors[childIndex].calendarRange">
                        <ng-template *ngTemplateOutlet="calendarRangeTemplate; context: {$implicit: column}">
                        </ng-template>
                    </div>
                    <div *ngFor="let column of featureSelectors[childIndex].calendarEqual">
                        <ng-template *ngTemplateOutlet="calendarEqualTemplate; context: {$implicit: column}">
                        </ng-template>
                    </div>
                    <div *ngFor="let column of featureSelectors[childIndex].dropdown">
                        <ng-template *ngTemplateOutlet="dropdownTemplate; context: {$implicit: column}">
                        </ng-template>
                    </div>
                    <div *ngFor="let column of featureSelectors[childIndex].searchableDropdown">
                        <ng-template *ngTemplateOutlet="searchableDropdownTemplate; context: {$implicit: column}">
                        </ng-template>
                    </div>
                    <div *ngFor="let column of featureSelectors[childIndex].checklistDropdown">
                        <ng-template *ngTemplateOutlet="checklistDropdownTemplate; context: {$implicit: column}">
                        </ng-template>
                    </div>
                    <div *ngFor="let column of featureSelectors[childIndex].searchableChecklistDropdown">
                        <ng-template
                            *ngTemplateOutlet="searchableChecklistDropdownTemplate; context: {$implicit: column}">
                        </ng-template>
                    </div>
                    <div *ngFor="let column of featureSelectors[childIndex].text">
                        <ng-template *ngTemplateOutlet="textTemplate; context: {$implicit: column}">
                        </ng-template>
                    </div>
                    <div *ngFor="let column of featureSelectors[childIndex].bool">
                        <ng-template *ngTemplateOutlet="boolTemplate; context: {$implicit: column}">
                        </ng-template>
                    </div>
                </mat-expansion-panel>
            </mat-accordion>
        </div>
        <button id="apply-button" mat-button (click)="applyFilters()">APPLY</button>
    </mat-sidenav>

    <mat-sidenav-content class="sidenav-content">
        <!-- table -->
        <div *ngIf="tableObject" id="table-buttons" fxLayoutAlign="end center">
            <button *ngIf="!editingMode" mat-icon-button (click)="toggleEditingMode()">
                <mat-icon>edit</mat-icon>
            </button>
            <button *ngIf="!editingMode" mat-icon-button>
                <mat-icon>save_alt</mat-icon>
            </button>
            <button *ngIf="editingMode" mat-icon-button (click)="cancelEditing()">
                <mat-icon>cancel</mat-icon>
            </button>
            <button *ngIf="editingMode" mat-icon-button (click)="toggleEditingMode()">
                <mat-icon>save</mat-icon>
            </button>
        </div>

        <!-- table -->
        <ngx-datatable *ngIf="tableObject" id="table" #table class="material" [headerHeight]="50" [footerHeight]="50"
            rowHeight="auto" [limit]="5" [rows]="rows" [scrollbarH]="true">
            <ngx-datatable-column *ngFor="let col of dataTableColumns" [prop]="col.prop" [name]="col.prop">
                <!-- cell -->
                <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-row="row" let-value="value">
                    <!-- depending on the column data type, cell has different ui for editing -->
                    <span [ngSwitch]="col.type">
                        <div *ngSwitchCase="'hyperlink'"
                            [ngStyle]="cellEdited[rowIndex + col.prop] && { 'background-color': 'pink' }">
                            <!-- if not in editing mode display link-->
                            <a [href]="row['_hyperlinks'][col.prop]" (click)="toggleEditingCell(rowIndex, col.prop)"
                                *ngIf="!editingMode">{{value}}
                            </a>
                            <!-- if in editing mode but not editing cell display text-->
                            <span (click)="toggleEditingCell(rowIndex, col.prop)"
                                *ngIf="!currentlyEditingCell[rowIndex + col.prop] && editingMode">
                                {{ value }}
                            </span>
                            <!-- if in editing mode and editing cell display input -->
                            <input *ngIf="currentlyEditingCell[rowIndex + col.prop] && editingMode"
                                (blur)="toggleEditingCell(rowIndex, col.prop)"
                                (change)="updateValue($event, col.prop, rowIndex)" [value]="value"
                                style="width: 90%;" />
                        </div>
                        <div *ngSwitchCase="'string'"
                            [ngStyle]="cellEdited[rowIndex + col.prop] && { 'background-color': 'pink' }">
                            <!-- if not editing cell, display value -->
                            <span (click)="toggleEditingCell(rowIndex, col.prop)"
                                *ngIf="!currentlyEditingCell[rowIndex + col.prop]">
                                {{ value }}
                            </span>
                            <!-- if editing cell, display input -->
                            <input *ngIf="currentlyEditingCell[rowIndex + col.prop] && editingMode"
                                (blur)="toggleEditingCell(rowIndex, col.prop)"
                                (change)="updateValue($event, col.prop, rowIndex)" [value]="value"
                                style="width: 90%;" />
                        </div>
                        <div *ngSwitchCase="'bool'"
                            [ngStyle]="cellEdited[rowIndex + col.prop] && { 'background-color': 'pink' }">
                            <!-- if not editing cell, display value -->
                            <span (click)="toggleEditingCell(rowIndex, col.prop)"
                                *ngIf="!currentlyEditingCell[rowIndex + col.prop]">
                                {{ value }}
                            </span>
                            <!-- if editing cell, display select -->
                            <select *ngIf="currentlyEditingCell[rowIndex + col.prop] && editingMode"
                                (blur)="toggleEditingCell(rowIndex, col.prop)"
                                (change)="updateValue($event, col.prop, rowIndex)" [value]="value">
                                <option value="True">True</option>
                                <option value="False">False</option>
                            </select>
                        </div>
                    </span>
                </ng-template>
            </ngx-datatable-column>
        </ngx-datatable>
    </mat-sidenav-content>
</mat-sidenav-container>

<!-- reusable tempates -->
<ng-template #numericChoiceTemplate let-info>
    <mat-form-field>
        <mat-label>{{info.column.frontendName}}</mat-label>
        <input matInput placeholder="ex: 4.5" [(ngModel)]='appliedFilterSelections[info.returnableID]'>
    </mat-form-field>
</ng-template>

<ng-template #numericEqualTemplate let-info>
    <mat-form-field>
        <mat-label>{{info.column.frontendName}}</mat-label>
        <input matInput placeholder="ex: 4.5" [(ngModel)]='appliedFilterSelections[info.returnableID]'>
    </mat-form-field>
</ng-template>

<ng-template #dropdownTemplate let-info>
    <mat-form-field>
        <mat-label>{{info.column.frontendName}}</mat-label>
        <mat-select [(ngModel)]="appliedFilterSelections[info.returnableID]">
            <!-- <mat-option *ngFor="let val of column.columnObject.selector.selectorValues" [value]=val>
                {{val}}
            </mat-option> -->
        </mat-select>
    </mat-form-field>
</ng-template>

<ng-template #calendarRangeTemplate let-info>
    <div style="width: 85%; margin-left: auto; margin-right: auto;" *ngIf="appliedFilterSelections[info.returnableID]">
        <mat-form-field style="width: 50%;">
            <input matInput class="datetime-picker" type="datetime-local" placeholder={{info.column.frontendName}}
                [(ngModel)]="appliedFilterSelections[info.returnableID].start">
        </mat-form-field>
        <mat-form-field style="width: 50%;">
            <input matInput class="datetime-picker" type="datetime-local"
                [(ngModel)]="appliedFilterSelections[info.returnableID].end">
        </mat-form-field>
    </div>
</ng-template>

<ng-template #calendarEqualTemplate let-info>
    <mat-form-field>
        <input matInput type="datetime-local" placeholder="info.column.frontendName"
            [(ngModel)]="appliedFilterSelections[info.returnableID]">
    </mat-form-field>
</ng-template>

<ng-template #searchableDropdownTemplate let-info>
    <ng-multiselect-dropdown class="multi" [placeholder]="info.column.frontendName"
        [(ngModel)]="appliedFilterSelections[info.returnableID]" [settings]="searchableDropdownSettings"
        [data]="dropdownList" (onSelect)="onItemSelect($event)" (onSelectAll)="onSelectAll($event)">
    </ng-multiselect-dropdown>
</ng-template>

<ng-template #checklistDropdownTemplate let-info>
    <ng-multiselect-dropdown class="multi" [placeholder]="info.column.frontendName"
        [(ngModel)]="appliedFilterSelections[info.returnableID]" [settings]="checklistDropdownSettings"
        [data]="dropdownList" (onSelect)="onItemSelect($event)" (onSelectAll)="onSelectAll($event)">
    </ng-multiselect-dropdown>
</ng-template>

<ng-template #searchableChecklistDropdownTemplate let-info>
    <ng-multiselect-dropdown class="multi" [placeholder]="info.column.frontendName"
        [(ngModel)]="appliedFilterSelections[info.returnableID]" [settings]="searchableChecklistDropdownSettings"
        [data]="dropdownList" (onSelect)="onItemSelect($event)" (onSelectAll)="onSelectAll($event)">
    </ng-multiselect-dropdown>
</ng-template>

<ng-template #textTemplate let-info>
    <mat-form-field>
        <mat-label>{{info.column.frontendName}}</mat-label>
        <input matInput placeholder="ex: 4.5" [(ngModel)]='appliedFilterSelections[info.returnableID]'>
    </mat-form-field>
</ng-template>

<ng-template #boolTemplate let-info>
    <mat-form-field>
        <mat-label>{{info.column.frontendName}}</mat-label>
        <mat-select [(ngModel)]="appliedFilterSelections[info.returnableID]">
            <mat-option [value]=true>True</mat-option>
            <mat-option [value]=false>False</mat-option>
        </mat-select>
    </mat-form-field>
</ng-template>